{% extends "discussion/base.html" %}

{% load static %}
{% load text_extras %}

{% block title %}{{ obj.title|striptags }} | {{ block.super }}{% endblock %}

{% block main-content-header-text %}{{ obj.title|striptags }}{% endblock %}

{% block extrastatics %}
    <link rel="stylesheet" href="{% static 'css/simplemde.min.css' %}">
    <script src="{% static 'js/simplemde.min.js' %}"></script>
{% endblock %}

{% block listing %}
    <a class="nav-link pl-0 mb-3" href="{% url 'comment-thread' obj.thread %}">Zobrazit chronologicky celé vlákno</a>

    <div>
        {% if obj.is_anonymous %}<a href="{% if obj.anonymous.author %}{% url 'comment-user' obj.anonymous.author %}{% else %}{% url 'comment-user' %}{% endif %}">{{ obj.anonymous.author }}</a> (neregistrovaný){% else %}<a href="{% if obj.user.username %}{% url 'comment-user' obj.user.username %}{% else %}{% url 'comment-user' %}{% endif %}">{{ obj.user.username }}</a>{% endif %},
        {{ obj.timestamp|date:"d.m.Y H:i:s" }}
    </div>
    <div class="mt-1">{{ obj.content|raw_text_to_html }}</div>

    {% if request.user.is_authenticated %}
    <h4 class="mt-4">Odpovědět</h4>
    <form method="POST" action="{% url 'comment-detail' obj.id %}">
        {% csrf_token %}
        {% include 'forms/form.html' with form=form %}
        <button type="submit" name="action" value="user-edit" class="tm-btn btn-primary">Odeslat</button>
    </form>
    <script>
        var helpTextElement = document.getElementById("id_content_helptext");
        if (helpTextElement) {
            var contentHelpText = helpTextElement.innerHTML;
            var firstLineEnd = contentHelpText.indexOf("<br>");
            var firstLineText = contentHelpText.slice(0, firstLineEnd);
            var newContentHelpText = contentHelpText.replace(firstLineText, "");
            while (newContentHelpText.indexOf("<br>") == 0) {
                newContentHelpText = newContentHelpText.replace("<br>", "");
            }
            helpTextElement.innerHTML = newContentHelpText;
            helpTextElement.classList.add("collapse");
            var collapseElement = document.createElement("SMALL");
            collapseElement.innerHTML = firstLineText + ' ' +
                '<a data-toggle="collapse" href="#id_content_helptext" aria-expanded="false" ' +
                'aria-controls="id_content_helptext">(&downarrow;)</a>';
            helpTextElement.parentNode.insertBefore(collapseElement, helpTextElement);
        }

        var content_mde = new SimpleMDE({
            autosave: {
                enabled: false,
                uniqueId: "photo-comment",
            },
            element: document.getElementById("id_content"),
            forceSync: true,
            hideIcons: [
                "heading", "heading-smaller", "heading-bigger", "heading-1",
                "heading-2", "code", "clean-block", "table", "side-by-side",
                "fullscreen"
            ],
            indentWithTabs: false,
            lineWrapping: true,
            showIcons: [
                "bold", "italic", "strikethrough", "heading-3", "quote",
                "unordered-list", "ordered-list", "link", "image",
                "horizontal-rule", "preview", "guide"
            ],
            spellChecker: false,
            status: false
        });
    </script>
    {% endif %}

    <h4 class="mt-4">Vlákno</h4>
    <a class="nav-link pl-0 mb-2" href="{% url 'comment-thread' obj.thread %}">Zobrazit chronologicky celé vlákno</a>
    <ul class="list-group">
    {% for o in thread_tree %}
        <li class="list-group-item fp-discussion-item{% if o == obj %} text-danger{% endif %}" style="padding-left: {% widthratio o.level 1 20 %}px">
            {% if o == obj %}{{ o.title }}{% else %}<a href="{{ o.get_absolute_url }}">{{ o.title }}</a>{% endif %}
            (<strong>{% if o.is_anonymous %}{{ o.anonymous.author }} (neregistrovaný){% else %}{{ o.user.username }}{% endif %}</strong>
            {{ o.timestamp|date:"d.m.Y H:i:s" }})
        </li>
    {% endfor %}
    </ul>
{% endblock %}
